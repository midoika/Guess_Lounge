<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>live challenge archiver (Mapboxç‰ˆ)</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        #summary {
            margin-top: 20px;
            padding: 10px;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
        }
        #map {
            height: 500px;
            width: 95%;
            margin: auto;
        }
        #leaderboard {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
        }
        .player {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        #customContextMenu {
            position: absolute;
            display: none;
            background: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h3>ä¿å­˜ç‰ˆ Live challenge result</h3>
    <div id="summary"><div id="summaryContent"></div></div>
    <div id="map"></div>
    <div id="leaderboard">
        <h4>ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ (ç‚¹æ•°ã‚¯ãƒªãƒƒã‚¯ã§ã‚²ã‚¹åœ°ç‚¹ã¸ã‚ºãƒ¼ãƒ ã™ã‚‹ã€‚Click scores to zoom in the places they guessed.)</h4>
        <h4>(ğŸ“å³ã‚¯ãƒªãƒƒã‚¯ã§ä»–ã®ãƒãƒƒãƒ—ã§è¦‹ã‚‹ã€‚Right-click map pin and choose other maps.)</h4>
        <div id="leaderboardEntries"></div>
    </div>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.4/firebase-firestore.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlkb2lrYSIsImEiOiJjbWJkMWphdXcyMG96MnFvazRxMGJpbTY4In0.3NrJHptVZSItqmRDrGdFNA'; // â†ã“ã“ã‚’è‡ªåˆ†ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«å¤‰æ›´

        // context menu
        const contextMenu = document.createElement('div');
        contextMenu.id = 'customContextMenu';
        document.body.appendChild(contextMenu);

        function createMenuItem(text, onClick) {
            const item = document.createElement('div');
            item.textContent = text;
            item.style.padding = '5px 10px';
            item.style.cursor = 'pointer';
            item.addEventListener('click', () => {
                onClick();
                contextMenu.style.display = 'none';
            });
            item.addEventListener('mouseover', () => item.style.background = '#ddd');
            item.addEventListener('mouseout', () => item.style.background = '');
            return item;
        }

        // --- FirebaseåˆæœŸåŒ– ---
        firebase.initializeApp({
            apiKey: 'AIzaSyAnf22xkIpGaLTMNDkjYL-e4ochtbkfYJ4',
            projectId: 'mido-96308',
        });
        const db = firebase.firestore();

        // URLã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
        const params = new URLSearchParams(window.location.search);
        const collectionName = params.get('collection');
        const documentId = params.get('document');

        // mapã¨markerç®¡ç†
        let map, markers = [];
        let activeMarkers = {}, activePolylines = {};

        // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
        function initMap(coordinates) {
            // åˆæœŸåº§æ¨™
            let center = (coordinates.length > 0) ? [coordinates[0].lng, coordinates[0].lat] : [139.6917, 35.6895];
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: center,
                zoom: 5,
                attributionControl: false
            });

            // åœ°å›³ã®å…¨ãƒ”ãƒ³å‰Šé™¤
            markers.forEach(marker => marker.remove());
            markers = [];

            // åº§æ¨™ã”ã¨ã«ãƒ”ãƒ³è¨­ç½®
            coordinates.forEach((coord, idx) => {
                const marker = addMarkerWithContextMenu(coord.lat, coord.lng, idx + 1);
                markers.push(marker);
            });

            // å…¨ãƒ”ãƒ³ãŒå…¥ã‚‹ã‚ˆã†ã«ã‚ºãƒ¼ãƒ 
            if (coordinates.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                coordinates.forEach(c => bounds.extend([c.lng, c.lat]));
                map.fitBounds(bounds, {padding: 50});
            }
        }

        // Context menuãƒ”ãƒ³
        function addMarkerWithContextMenu(lat, lng, labelText) {
            // ãƒ©ãƒ™ãƒ«ä»˜ããƒ”ãƒ³
            const el = document.createElement('div');
            el.style.background = '#4682b4';
            el.style.borderRadius = '50%';
            el.style.color = '#fff';
            el.style.width = '32px';
            el.style.height = '32px';
            el.style.display = 'flex';
            el.style.justifyContent = 'center';
            el.style.alignItems = 'center';
            el.style.fontWeight = 'bold';
            el.style.fontSize = '16px';
            el.style.cursor = 'pointer';
            el.textContent = labelText;

            const marker = new mapboxgl.Marker({element: el})
                .setLngLat([lng, lat])
                .addTo(map);

            // å·¦ã‚¯ãƒªãƒƒã‚¯ï¼ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ï¼ˆGoogleï¼‰
            el.addEventListener('click', () => {
                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
            });

            // å³ã‚¯ãƒªãƒƒã‚¯ï¼ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            el.addEventListener('contextmenu', (event) => {
                event.preventDefault();
                contextMenu.innerHTML = '';
                contextMenu.appendChild(createMenuItem('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹', () => {
                    navigator.clipboard.writeText(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`);
                }));
                contextMenu.appendChild(createMenuItem('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹', () => {
                    navigator.clipboard.writeText(`${lat},${lng}`);
                }));
                contextMenu.appendChild(createMenuItem('åœ°ç†é™¢åœ°å›³ã§è¦‹ã‚‹', () => {
                    window.open(`https://maps.gsi.go.jp/#15/${lat}/${lng}`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('ã‚€ã‹ã—ã®å¸‚ç”ºæ‘å¢ƒç•Œãƒãƒƒãƒ—ã§è¦‹ã‚‹', () => {
                    window.open(`https://hanishina.net/maps/historymap.html?y=${lat}&x=${lng}&z=12`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('Yahoo! ãƒãƒƒãƒ—ã§è¦‹ã‚‹', () => {
                    window.open(`https://map.yahoo.co.jp/?lat=${lat}&lon=${lng}&zoom=14`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('Open Street Map ã§è¦‹ã‚‹', () => {
                    window.open(`https://www.openstreetmap.org/#map=15/${lat}/${lng}`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('Appleãƒãƒƒãƒ— (Î²) ã§è¦‹ã‚‹', () => {
                    window.open(`https://beta.maps.apple.com/?ll=${lat}%2c${lng}`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('ãƒãƒ”ã‚ªãƒ³ã§è¦‹ã‚‹', () => {
                    window.open(`https://www.mapion.co.jp/m2/${lat},${lng},15`, '_blank');
                }));
                contextMenu.appendChild(createMenuItem('MapFanã§è¦‹ã‚‹', () => {
                    window.open(`https://mapfan.com/map?c=${lat},${lng},15`, '_blank');
                }));
                // ãƒã‚¦ã‚¹ä½ç½®ã«è¡¨ç¤º
                contextMenu.style.left = `${event.clientX + 10}px`;
                contextMenu.style.top = `${event.clientY}px`;
                contextMenu.style.display = 'block';
            });

            return marker;
        }

        // ã‚²ã‚¹ç”¨ï¼šã‚¢ãƒã‚¿ãƒ¼ãƒ”ãƒ³ã‚’ãƒãƒƒãƒ—ã«ãƒˆã‚°ãƒ«è¨­ç½®
        function toggleMarkerWithAvatar(lat, lng, avatarUrl, roundNumber) {
            if (!activeMarkers[roundNumber]) activeMarkers[roundNumber] = {};
            if (!activePolylines[roundNumber]) activePolylines[roundNumber] = {};

            if (activeMarkers[roundNumber][avatarUrl]) {
                activeMarkers[roundNumber][avatarUrl].remove();
                delete activeMarkers[roundNumber][avatarUrl];
                if (activePolylines[roundNumber][avatarUrl]) {
                    map.removeLayer(activePolylines[roundNumber][avatarUrl]);
                    map.removeSource(activePolylines[roundNumber][avatarUrl]);
                    delete activePolylines[roundNumber][avatarUrl];
                }
                return false;
            } else {
                // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒã‚¿ãƒ¼
                const el = document.createElement('img');
                el.src = avatarUrl;
                el.style.width = '40px';
                el.style.height = '40px';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid yellowgreen';
                el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
                el.style.cursor = 'pointer';

                const marker = new mapboxgl.Marker({element: el})
                    .setLngLat([lng, lat])
                    .addTo(map);

                el.addEventListener('click', () => {
                    window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
                });

                activeMarkers[roundNumber][avatarUrl] = marker;
                map.flyTo({center: [lng, lat], zoom: 12});

                // ç‚¹ç·šï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ã®åº§æ¨™â†’ã‚²ã‚¹åº§æ¨™ï¼‰
                if (markers[roundNumber - 1]) {
                    // ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ”ãƒ³ä½ç½®
                    const m = markers[roundNumber - 1].getLngLat();
                    const lineId = `poly-${roundNumber}-${avatarUrl}`;
                    map.addSource(lineId, {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': [
                                    [m.lng, m.lat], [lng, lat]
                                ]
                            }
                        }
                    });
                    map.addLayer({
                        'id': lineId,
                        'type': 'line',
                        'source': lineId,
                        'layout': {'line-cap': 'round'},
                        'paint': {
                            'line-color': '#000',
                            'line-width': 2,
                            'line-dasharray': [2,2]
                        }
                    });
                    activePolylines[roundNumber][avatarUrl] = lineId;
                }
                return true;
            }
        }

        // --- ä»¥ä¸‹ã€ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ã‚µãƒãƒªãƒ¼ãƒ»FireStoreèª­ã¿è¾¼ã¿å‡¦ç†ï¼ˆå…ƒã®ã¾ã¾ï¼‰ ---
        function displaySummary(data) {
            const summaryContent = document.getElementById('summaryContent');
            const firstRound = data.rounds[0];
            if (firstRound) {
                const startTime = new Date(firstRound.startTime).toLocaleString();
                const roundTime = firstRound.roundTime;
                const movementOptions = firstRound.question?.panoramaQuestionPayload?.movementOptions || {};
                const mapName = firstRound.question?.panoramaQuestionPayload?.mapName || 'ä¸æ˜';
                const mapSlug = firstRound.question?.panoramaQuestionPayload?.mapSlug || 'ä¸æ˜';
                summaryContent.innerHTML = `
                    <p>Start: ${startTime}   time: ${roundTime}s   ${movementOptions.forbidMoving ? 'No Move ' : 'Move '}, 
                    ${movementOptions.forbidRotating ? 'No Pan ' : 'Pan '},
                    ${movementOptions.forbidZooming ? 'No zoom ' : 'Zoom '}</p>
                    <p>Map: <a href="https://www.geoguessr.com/maps/${mapSlug}" target="_blank">${mapName}</a></p>
                `;
            } else {
                summaryContent.textContent = 'ãƒ©ã‚¦ãƒ³ãƒ‰æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
            }
        }

        function displayLeaderboard(entries) {
            const leaderboardContainer = document.getElementById('leaderboardEntries');
            leaderboardContainer.innerHTML = '';
            entries.forEach((entry, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                const rankSpan = document.createElement('span');
                let rankText = '';
                if (index === 0)      rankText = '1st';
                else if (index === 1) rankText = '2nd';
                else if (index === 2) rankText = '3rd';
                else                  rankText = `${index + 1}th`;
                rankSpan.textContent = rankText + ' ';
                rankSpan.className = 'rank';
                const avatar = document.createElement('img');
                avatar.src = "https://www.geoguessr.com/images/plain/" + entry.avatarPath;
                avatar.className = 'avatar';
                const nameAndScore = document.createElement('div');
                const nameLink = document.createElement('a');
                nameLink.href = 'https://www.geoguessr.com/user/' + entry.id;
                nameLink.textContent = entry.name;
                nameLink.className = 'name-link';
                nameAndScore.appendChild(nameLink);
                const scoreAndTimeSpan = document.createElement('span');
                scoreAndTimeSpan.style.cursor = 'pointer';
                scoreAndTimeSpan.textContent = `: ${entry.totalScore}pts (${entry.totalTime}s)`;
                scoreAndTimeSpan.addEventListener('click', () => {
                    const scores = playerDiv.querySelectorAll('.round-score');
                    scores.forEach(score => score.click());
                    const bounds = new mapboxgl.LngLatBounds();
                    entry.guesses.forEach(guess => {
                        if (guess.lat && guess.lng)
                            bounds.extend([guess.lng, guess.lat]);
                    });
                    map.fitBounds(bounds, {padding: 50});
                });
                nameAndScore.appendChild(scoreAndTimeSpan);
                const equalsSpan = document.createElement('span');
                equalsSpan.textContent = ' = ';
                nameAndScore.appendChild(equalsSpan);
                const roundScores = document.createElement('span');
                roundScores.className = 'round-scores';
                entry.guesses.forEach(guess => {
                    const roundScore = document.createElement('span');
                    roundScore.textContent = ` R${guess.roundNumber}: ${guess.score}pts`;
                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = `(${guess.time}s) `;
                    timeSpan.style.fontSize = 'smaller';
                    roundScore.appendChild(timeSpan);
                    roundScore.className = 'round-score';
                    roundScore.addEventListener('click', () => {
                        const result = toggleMarkerWithAvatar(guess.lat, guess.lng, avatar.src, guess.roundNumber);
                        if (result)   roundScore.style.color = 'yellowgreen';
                        else          roundScore.style.color = '';
                    });
                    roundScores.appendChild(roundScore);
                });
                playerDiv.appendChild(rankSpan);
                playerDiv.appendChild(avatar);
                playerDiv.appendChild(nameAndScore);
                playerDiv.appendChild(roundScores);
                leaderboardContainer.appendChild(playerDiv);
            });
        }

        // Mapboxã¯åˆæœŸåŒ–æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸è¦ãªã®ã§ã€Firestoreâ†’initMap
        if (collectionName && documentId) {
            db.collection(collectionName).doc(documentId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        displaySummary(data);
                        const coordinates = [];
                        if (data.rounds && Array.isArray(data.rounds)) {
                            data.rounds.forEach(round => {
                                const coordinate = round.answer?.coordinateAnswerPayload?.coordinate;
                                if (coordinate) {
                                    coordinates.push({
                                        lat: coordinate.lat,
                                        lng: coordinate.lng,
                                        streetViewLink: `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${coordinate.lat},${coordinate.lng}`
                                    });
                                }
                            });
                        }
                        initMap(coordinates);
                        if (Array.isArray(data.topPlayers)) {
                            displayLeaderboard(data.topPlayers);
                        } else {
                            document.getElementById('leaderboardEntries').textContent = 'ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                        }
                    } else {
                        alert('æŒ‡å®šã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error fetching document: ', error);
                    alert('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        } else {
            alert('ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã¾ãŸã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        }
        document.addEventListener('click', () => {
        contextMenu.style.display = 'none';
    });

</script>
<script>
    // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½œæˆ
const contextMenu = document.createElement('div');
contextMenu.id = 'customContextMenu';
contextMenu.style.position = 'absolute';
contextMenu.style.display = 'none';
contextMenu.style.background = '#fff';
contextMenu.style.border = '1px solid #ccc';
contextMenu.style.padding = '5px';
contextMenu.style.boxShadow = '2px 2px 10px rgba(0, 0, 0, 0.2)';
contextMenu.style.zIndex = '1000';
document.body.appendChild(contextMenu);

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®ä½œæˆ
function createMenuItem(text, onClick) {
    const item = document.createElement('div');
    item.textContent = text;
    item.style.padding = '5px 10px';
    item.style.cursor = 'pointer';
    item.addEventListener('click', () => {
        onClick();
        contextMenu.style.display = 'none';
    });
    item.addEventListener('mouseover', () => item.style.background = '#ddd');
    item.addEventListener('mouseout', () => item.style.background = '');
    return item;
}

// ãƒ”ãƒ³ã®å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
function addMarkerWithContextMenu(lat, lng, labelText) {
    const el = document.createElement('div');
    el.style.background = '#4682b4';
    el.style.borderRadius = '50%';
    el.style.color = '#fff';
    el.style.width = '32px';
    el.style.height = '32px';
    el.style.display = 'flex';
    el.style.justifyContent = 'center';
    el.style.alignItems = 'center';
    el.style.fontWeight = 'bold';
    el.style.fontSize = '16px';
    el.style.cursor = 'pointer';
    el.textContent = labelText;

    const marker = new mapboxgl.Marker({ element: el })
        .setLngLat([lng, lat])
        .addTo(map);

    // ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯
    el.addEventListener('click', () => {
        window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, '_blank');
    });

    el.addEventListener('contextmenu', (event) => {
        event.preventDefault();
        contextMenu.innerHTML = '';
        contextMenu.appendChild(createMenuItem('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹', () => {
            navigator.clipboard.writeText(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`);
        }));
        contextMenu.appendChild(createMenuItem('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹', () => {
            navigator.clipboard.writeText(`${lat},${lng}`);
        }));
        contextMenu.appendChild(createMenuItem('åœ°ç†é™¢åœ°å›³ã§è¦‹ã‚‹', () => {
            window.open(`https://maps.gsi.go.jp/#15/${lat}/${lng}`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('ã‚€ã‹ã—ã®å¸‚ç”ºæ‘å¢ƒç•Œãƒãƒƒãƒ—ã§è¦‹ã‚‹', () => {
            window.open(`https://hanishina.net/maps/historymap.html?y=${lat}&x=${lng}&z=12`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('Yahoo! ãƒãƒƒãƒ—ã§è¦‹ã‚‹', () => {
            window.open(`https://map.yahoo.co.jp/?lat=${lat}&lon=${lng}&zoom=14`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('Open Street Map ã§è¦‹ã‚‹', () => {
            window.open(`https://www.openstreetmap.org/#map=15/${lat}/${lng}`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('Appleãƒãƒƒãƒ— (Î²) ã§è¦‹ã‚‹', () => {
            window.open(`https://beta.maps.apple.com/?ll=${lat}%2c${lng}`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('ãƒãƒ”ã‚ªãƒ³ã§è¦‹ã‚‹', () => {
            window.open(`https://www.mapion.co.jp/m2/${lat},${lng},15`, '_blank');
        }));
        contextMenu.appendChild(createMenuItem('MapFanã§è¦‹ã‚‹', () => {
            window.open(`https://mapfan.com/map?c=${lat},${lng},15`, '_blank');
        }));

        contextMenu.style.left = `${event.clientX + 10}px`;
        contextMenu.style.top = `${event.clientY}px`;
        contextMenu.style.display = 'block';
    });

    return marker;
}

// ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
document.addEventListener('click', () => {
    contextMenu.style.display = 'none';
});

</script>

