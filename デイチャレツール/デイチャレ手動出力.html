<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Challenge コメント生成</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 20px; }
    .row { margin: 10px 0; }
    label { display: inline-block; min-width: 110px; }
    input[type="text"], input[type="date"] { width: min(720px, 95%); padding: 8px; }
    fieldset { width: min(740px, 98%); padding: 10px; }
    .buttons { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 10px 14px; cursor: pointer; }
    pre, textarea {
      width: min(820px, 98%);
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fafafa;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
    }
    .error { color: #b00020; margin-top: 8px; }
    .ok { color: #0a7a0a; margin-top: 8px; }
    .hint { color: #555; font-size: 13px; margin-top: 4px; }
  </style>
</head>
<body>
  <h2>デイリーチャレンジコメント生成</h2>

  <div class="row">
    <label for="date">日付</label>
    <input id="date" type="date" />
    <div class="hint">この日付の「日本時間 07:00」に相当する Unix 秒を <code>&lt;t:...:D&gt;</code> に使います</div>
  </div>

  <div class="row">
    <label for="link">リンク</label>
    <input id="link" type="text" placeholder="https://www.geoguessr.com/challenge/..." />
  </div>

  <div class="row">
    <label for="map">マップ</label>
    <input id="map" type="text" placeholder="Japan • 日本 60k+" />
  </div>

  <fieldset>
    <legend>ゲームモード（どれか1つ必須）</legend>
    <label><input type="radio" name="mode" value="Move" /> Move</label>&nbsp;&nbsp;
    <label><input type="radio" name="mode" value="NM" /> NM</label>&nbsp;&nbsp;
    <label><input type="radio" name="mode" value="NMPZ" /> NMPZ</label>
    <div class="hint">時間は固定で <b>60s</b> を付けます（例：NM 60s）</div>
  </fieldset>

  <div class="buttons">
    <button id="generate" type="button">生成</button>
    <button id="copy" type="button">コピー</button>
    <button id="clear" type="button">クリア</button>
  </div>

  <div id="msg" class=""></div>

  <h3>出力</h3>
  <textarea id="out" rows="6" readonly placeholder="ここに生成結果が出ます"></textarea>

  <script>
	function autoSelectModeByDate(dateStr) {
		// dateStr: "YYYY-MM-DD"
		if (!dateStr) return;

		const [y, m, d] = dateStr.split("-").map(Number);

		// JST基準で曜日を出す
		const date = new Date(y, m - 1, d);
		const day = date.getDay(); // 0=日,1=月,...6=土

		let mode = "";
		if (day === 0) {
		mode = "NMPZ";           // 日
		} else if (day === 2 || day === 4 || day === 6) {
		mode = "NM";             // 火・木・土
		} else {
		mode = "Move";           // 月・水・金
		}

		// ラジオボタンを反映
		document.querySelectorAll('input[name="mode"]').forEach(r => {
		r.checked = (r.value === mode);
		});
	}

	document.getElementById("date").addEventListener("change", (e) => {
	  autoSelectModeByDate(e.target.value);
	});


    function getSelectedMode() {
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : "";
    }

    // yyyy-mm-dd を「その日の JST 07:00」にして unix 秒へ
    // JST = UTC+9 なので 07:00 JST = 22:00 UTC（前日）
    function unixAtJst0700(dateStr) {
      // dateStr: "2026-01-21"
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dateStr);
      if (!m) return null;
      const y = Number(m[1]);
      const mo = Number(m[2]) - 1; // 0-based
      const d = Number(m[3]);

      // Date.UTC は hour が負でも OK（自動で前日に繰り上がる）
      const ms = Date.UTC(y, mo, d, 7 - 9, 0, 0); // 07:00 JST -> -2:00 UTC -> 前日22:00 UTC
      return Math.floor(ms / 1000);
    }

    function setMsg(text, ok) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = ok ? "ok" : "error";
    }

    function generate() {
      const dateStr = document.getElementById("date").value.trim();
      const link = document.getElementById("link").value.trim();
      const map = document.getElementById("map").value.trim();
      const mode = getSelectedMode();

      // validation
      if (!dateStr) return setMsg("エラー：日付を選んでください", false);
      if (!link) return setMsg("エラー：リンクを入力してください", false);
      if (!map) return setMsg("エラー：マップを入力してください", false);
      if (!mode) return setMsg("エラー：ゲームモード（Move / NM / NMPZ）を1つ選んでください", false);

      const unix = unixAtJst0700(dateStr);
      if (unix === null) return setMsg("エラー：日付形式が不正です", false);

      const text =
`## <t:${unix}:D>のデイリーチャレンジ
リンク：${link}
マップ：${map}
ゲームモード：${mode} 60s
`;

      document.getElementById("out").value = text;
      setMsg("生成しました", true);
    }

    async function copyOut() {
      const out = document.getElementById("out").value;
      if (!out) return setMsg("エラー：先に生成してください", false);
      try {
        await navigator.clipboard.writeText(out);
        setMsg("コピーしました", true);
      } catch (e) {
        setMsg("コピーに失敗しました（ブラウザの権限設定を確認してください）", false);
      }
    }

    function clearAll() {
      document.getElementById("date").value = "";
      document.getElementById("link").value = "";
      document.getElementById("map").value = "";
      document.querySelectorAll('input[name="mode"]').forEach(r => r.checked = false);
      document.getElementById("out").value = "";
      setMsg("", true);
      document.getElementById("msg").className = "";
    }

    document.getElementById("generate").addEventListener("click", generate);
    document.getElementById("copy").addEventListener("click", copyOut);
    document.getElementById("clear").addEventListener("click", clearAll);
  </script>
</body>
</html>
